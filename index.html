<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi QR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            
            <!-- Tampilan Login -->
            <div id="login-container">
                <h1 class="text-4xl font-bold text-slate-900">Presensi QR</h1>
                <p class="mt-2 text-slate-500 mb-8">Login dengan akun Google untuk mencatat kehadiran Anda.</p>
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 inline-flex items-center justify-center">
                    <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                    Login dengan Google
                </button>
            </div>

            <!-- Tampilan Presensi (Setelah Login) -->
            <div id="attendance-container" class="hidden">
                <div id="user-info" class="mb-6 text-left">
                    <p class="text-sm text-slate-500">Selamat datang,</p>
                    <p id="user-name" class="font-semibold text-slate-800"></p>
                    <p id="user-email" class="text-sm text-slate-500"></p>
                </div>

                <div id="status-display" class="w-full p-4 rounded-lg text-center mb-6">
                    <h2 id="status-title" class="text-xl font-bold"></h2>
                    <p id="status-message" class="mt-1"></p>
                </div>
                
                 <div id="history-section">
                    <h3 class="text-xl font-semibold text-slate-800 text-left mb-4">Riwayat Presensi Anda</h3>
                    <div id="history-list" class="space-y-3 h-48 overflow-y-auto text-left">
                        <!-- Riwayat akan diisi oleh JavaScript -->
                    </div>
                </div>

                <button id="logout-btn" class="mt-8 text-sm text-indigo-600 hover:text-indigo-800 font-semibold">Logout</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Referensi DOM ---
        const loginContainer = document.getElementById('login-container');
        const attendanceContainer = document.getElementById('attendance-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userNameDisplay = document.getElementById('user-name');
        const userEmailDisplay = document.getElementById('user-email');
        const statusDisplay = document.getElementById('status-display');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        const historyList = document.getElementById('history-list');

        // --- Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDb7mCPgC-GAVfd8bjI7hpypF_iYPA4Ob8",
            authDomain: "prensensi-qr.firebaseapp.com",
            projectId: "prensensi-qr",
            storageBucket: "prensensi-qr.appspot.com",
            messagingSenderId: "372766345596",
            appId: "1:372766345596:web:331ddc11a7b461273d3cf9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let unsubscribeFromHistory = null;

        // --- Logika Login / Logout ---
        loginBtn.addEventListener('click', () => signInWithPopup(auth, provider).catch(error => console.error("Login Gagal:", error)));
        logoutBtn.addEventListener('click', () => signOut(auth).catch(error => console.error("Logout Gagal:", error)));

        // --- Otentikasi ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginContainer.style.display = 'none';
                attendanceContainer.style.display = 'block';
                userNameDisplay.textContent = user.displayName || 'Nama Tidak Ditemukan';
                userEmailDisplay.textContent = user.email;
                
                if (unsubscribeFromHistory) unsubscribeFromHistory();
                listenForHistory(user.uid);
                
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('sessionId');
                
                if (sessionId) {
                    handleAttendance(sessionId, user);
                } else {
                    showStatus('info', 'Tidak Ada Sesi Aktif', 'Buka halaman ini dari QR code presensi.');
                }
            } else {
                loginContainer.style.display = 'block';
                attendanceContainer.style.display = 'none';
                 if (unsubscribeFromHistory) unsubscribeFromHistory();
            }
        });
        
        async function handleAttendance(sessionId, user) {
            showStatus('loading', 'Memproses...', 'Mohon tunggu sebentar.');

            try {
                // 1. Periksa apakah user sudah pernah absen di sesi ini
                const attendanceDocRef = doc(db, `presensi/${sessionId}/peserta`, user.uid);
                const attendanceDocSnap = await getDoc(attendanceDocRef);

                if (attendanceDocSnap.exists()) {
                    showStatus('warning', 'Presensi Ganda', 'Anda sudah tercatat dalam presensi untuk sesi ini.');
                    return; // Hentikan proses
                }

                // 2. Periksa status sesi (terbuka atau tertutup)
                const sessionDocRef = doc(db, "kegiatan", sessionId);
                const sessionDocSnap = await getDoc(sessionDocRef);

                if (!sessionDocSnap.exists()) {
                    showStatus('error', 'Sesi Tidak Ditemukan', 'Sesi presensi ini tidak valid atau sudah dihapus.');
                    return;
                }
                
                const sessionData = sessionDocSnap.data();
                if (sessionData.status === 'tutup') {
                    showStatus('error', 'Sesi Ditutup', 'Sesi presensi untuk kegiatan ini sudah ditutup oleh admin.');
                    return;
                }

                // 3. Jika semua valid, lanjutkan proses presensi
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    const locationData = { lat: latitude, lng: longitude };
                    await recordAttendance(sessionId, user, sessionData.nama, locationData);
                }, async (error) => {
                    console.warn("Gagal mendapatkan lokasi:", error.message);
                    await recordAttendance(sessionId, user, sessionData.nama, null); // Tetap lanjutkan tanpa data lokasi
                });

            } catch (error) {
                console.error("Error saat menangani presensi:", error);
                // Menangani error permission denied secara spesifik
                if (error.code === 'permission-denied') {
                     showStatus('warning', 'Presensi Ganda', 'Anda sudah tercatat dalam presensi untuk sesi ini.');
                } else {
                     showStatus('error', 'Gagal', 'Terjadi kesalahan. Silakan coba lagi.');
                }
            }
        }

        async function recordAttendance(sessionId, user, sessionName, locationData) {
            const now = new Date();
            const attendanceData = {
                nama: user.displayName,
                email: user.email,
                waktu: now,
                lokasi: locationData,
            };
            const userLogData = {
                namaSesi: sessionName,
                waktu: now,
                sessionId: sessionId,
            };

            try {
                // Simpan ke daftar hadir global
                const attendanceDocRef = doc(db, `presensi/${sessionId}/peserta`, user.uid);
                await setDoc(attendanceDocRef, attendanceData);

                // Simpan ke riwayat pribadi user
                const logDocRef = doc(db, `users/${user.uid}/logs`, sessionId); // Gunakan sessionId sebagai ID log
                await setDoc(logDocRef, userLogData);
                
                showStatus('success', 'Berhasil!', `Presensi Anda untuk "${sessionName}" telah tercatat.`);
            } catch (error) {
                 console.error("Error saat mencatat presensi:", error);
                 if (error.code === 'permission-denied') {
                     showStatus('warning', 'Presensi Ganda', 'Anda sudah tercatat dalam presensi untuk sesi ini.');
                 } else {
                     showStatus('error', 'Gagal', 'Gagal mencatat data. Cek console untuk detail.');
                 }
            }
        }
        
        function listenForHistory(userId) {
            const historyCollectionRef = collection(db, `users/${userId}/logs`);
            const q = query(historyCollectionRef, orderBy('waktu', 'desc'));
            
            unsubscribeFromHistory = onSnapshot(q, 
                (snapshot) => { // Callback jika berhasil
                    if (snapshot.empty) {
                        historyList.innerHTML = '<p class="text-slate-500 text-center py-4">Belum ada riwayat presensi.</p>';
                        return;
                    }
                    historyList.innerHTML = snapshot.docs.map(doc => {
                        const log = doc.data();
                        const time = log.waktu.toDate().toLocaleString('id-ID', {
                            day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                        return `
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <p class="font-medium text-slate-800">${escapeHTML(log.namaSesi)}</p>
                                <p class="text-xs text-slate-500">${time}</p>
                            </div>
                        `;
                    }).join('');
                },
                (error) => { // Callback jika terjadi error
                    console.error("Gagal memuat riwayat:", error);
                    historyList.innerHTML = `<div class="text-red-600 bg-red-100 p-3 rounded-lg text-center">
                        <p class="font-semibold">Gagal Memuat Riwayat</p>
                        <p class="text-sm">Pastikan aturan keamanan Firebase sudah benar dan dipublikasikan.</p>
                    </div>`;
                }
            );
        }
        
        function showStatus(type, title, message) {
            const colors = {
                info: 'bg-blue-100 text-blue-800',
                success: 'bg-green-100 text-green-800',
                warning: 'bg-amber-100 text-amber-800',
                error: 'bg-red-100 text-red-800',
                loading: 'bg-slate-100 text-slate-800'
            };
            statusDisplay.className = `w-full p-4 rounded-lg text-center mb-6 ${colors[type]}`;
            statusTitle.textContent = title;
            statusMessage.textContent = message;
        }

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str || "";
            return p.innerHTML;
        }
    </script>
</body>
</html>