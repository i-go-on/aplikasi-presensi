<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Presensi QR - Dashboard Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Library untuk membuat QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .glass-card-white {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-bg-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-bg-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .gradient-bg-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        #qrcode-container { 
            min-height: 256px; 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        #attendance-table th, #attendance-table td { 
            padding: 16px 20px; 
        }
        
        .table-row {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 4px 0;
        }
        
        .table-row:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: translateX(8px);
        }
        
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        
        .btn-modern {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-modern:hover::before {
            left: 100%;
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-active {
            background: #10b981;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        
        .status-inactive {
            background: #ef4444;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">

    <div class="w-full max-w-7xl mx-auto">
        <!-- Tampilan Login -->
        <div id="login-container" class="flex items-center justify-center min-h-screen">
            <div class="glass-card-white rounded-3xl p-12 text-center max-w-md w-full card-hover">
                <div class="mb-8">
                    <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center mx-auto mb-6 floating">
                        <i class="fas fa-qrcode text-white text-3xl"></i>
                    </div>
                    <h1 class="text-4xl font-bold gradient-text mb-2">Admin Presensi</h1>
                    <p class="text-slate-600 text-lg">Dashboard Modern untuk Mengelola Sesi Presensi</p>
                </div>
                
                <button id="login-btn" class="btn-modern gradient-bg text-white font-semibold py-4 px-8 rounded-2xl w-full text-lg inline-flex items-center justify-center">
                    <i class="fab fa-google mr-3 text-xl"></i>
                    Login dengan Google
                </button>
                
                <div class="mt-8 text-sm text-slate-500">
                    <i class="fas fa-shield-alt mr-2"></i>
                    Aman dan Terpercaya
                </div>
            </div>
        </div>

        <!-- Tampilan Aplikasi Utama (Setelah Login) -->
        <div id="app-container" class="hidden">
            <!-- Header dengan Stats -->
            <div class="glass-card-white rounded-3xl p-8 mb-8">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8">
                    <div>
                        <h1 class="text-5xl font-bold gradient-text mb-2">Dasbor Admin</h1>
                        <p id="user-info" class="text-slate-600 text-lg flex items-center">
                            <i class="fas fa-user-circle mr-2"></i>
                            <span id="user-email"></span>
                        </p>
                    </div>
                    <button id="logout-btn" class="btn-modern glass-card px-6 py-3 rounded-2xl text-slate-700 font-semibold mt-4 lg:mt-0">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Logout
                    </button>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-card rounded-2xl p-6 text-center card-hover">
                        <div class="w-16 h-16 gradient-bg-secondary rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-users text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">Total Peserta</h3>
                        <p id="total-participants" class="text-3xl font-bold gradient-text">0</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 text-center card-hover">
                        <div class="w-16 h-16 gradient-bg-success rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-clock text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">Sesi Aktif</h3>
                        <p id="active-sessions" class="text-3xl font-bold gradient-text">0</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 text-center card-hover">
                        <div class="w-16 h-16 gradient-bg-warning rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-chart-line text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">Kehadiran Hari Ini</h3>
                        <p id="today-attendance" class="text-3xl font-bold gradient-text">0</p>
                    </div>
                </div>
            </div>

            <!-- Form Buat Sesi -->
            <div id="create-session-form" class="glass-card-white rounded-3xl p-8 mb-8 card-hover">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold gradient-text mb-2">Buat Sesi Presensi Baru</h2>
                    <p class="text-slate-600">Buat sesi presensi dengan nama kegiatan yang menarik</p>
                </div>
                
                <div class="flex flex-col lg:flex-row gap-6 items-end">
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-slate-700 mb-3">Nama Kegiatan</label>
                        <div class="relative">
                            <i class="fas fa-calendar-plus absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="session-name" placeholder="Contoh: Rapat Bulanan Tim Development" 
                                   class="w-full pl-12 pr-4 py-4 border-2 border-slate-200 rounded-2xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-lg">
                        </div>
                    </div>
                    <button id="create-session-btn" class="btn-modern gradient-bg text-white font-semibold py-4 px-8 rounded-2xl text-lg">
                        <i class="fas fa-plus mr-2"></i>
                        Buat Sesi & Tampilkan QR
                    </button>
                </div>
            </div>

            <!-- Tampilan Sesi Aktif -->
            <div id="active-session-container" class="hidden">
                <div class="glass-card-white rounded-3xl p-8">
                    <div class="text-center mb-8">
                        <h2 id="active-session-title" class="text-4xl font-bold gradient-text mb-4"></h2>
                        <div class="inline-flex items-center px-6 py-3 rounded-full glass-card">
                            <span class="status-indicator status-active"></span>
                            <span id="session-status" class="text-lg font-semibold text-slate-700">Sesi Terbuka</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                        <!-- Kolom QR Code -->
                        <div class="xl:col-span-1 text-center">
                            <div class="glass-card rounded-3xl p-8 mb-6">
                                <div id="qrcode-container" class="mx-auto w-72 h-72 mb-6 flex items-center justify-center">
                                    <canvas id="qrcode-canvas"></canvas>
                                </div>
                                <p class="text-slate-600 mb-4">
                                    <i class="fas fa-mobile-alt mr-2"></i>
                                    Arahkan peserta untuk memindai kode ini
                                </p>
                                <div class="flex gap-3 justify-center">
                                    <button id="download-qr" class="btn-modern glass-card px-4 py-2 rounded-xl text-slate-700">
                                        <i class="fas fa-download mr-2"></i>
                                        Download QR
                                    </button>
                                    <button id="share-qr" class="btn-modern glass-card px-4 py-2 rounded-xl text-slate-700">
                                        <i class="fas fa-share mr-2"></i>
                                        Share
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Kolom Daftar Kehadiran -->
                        <div class="xl:col-span-2">
                            <div class="glass-card rounded-3xl p-6">
                                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
                                    <div class="mb-4 lg:mb-0">
                                        <h3 class="text-2xl font-bold text-slate-800 mb-2">
                                            <i class="fas fa-list-check mr-3"></i>
                                            Daftar Kehadiran
                                        </h3>
                                        <p class="text-slate-600">
                                            Total: <span id="attendee-count" class="font-bold text-blue-600">0</span> peserta
                                        </p>
                                    </div>
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <button id="close-session-btn" class="btn-modern gradient-bg-warning text-white font-semibold py-3 px-6 rounded-xl">
                                            <i class="fas fa-stop-circle mr-2"></i>
                                            Tutup Presensi
                                        </button>
                                        <button id="export-csv-btn" class="btn-modern gradient-bg-success text-white font-semibold py-3 px-6 rounded-xl">
                                            <i class="fas fa-file-export mr-2"></i>
                                            Ekspor CSV
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="bg-white rounded-2xl border border-slate-200 h-96 overflow-y-auto p-4">
                                    <table id="attendance-table" class="w-full">
                                        <thead class="sticky top-0 bg-white z-10">
                                            <tr>
                                                <th class="text-left py-4 px-4 font-semibold text-slate-700">
                                                    <i class="fas fa-user mr-2"></i>Nama
                                                </th>
                                                <th class="text-left py-4 px-4 font-semibold text-slate-700">
                                                    <i class="fas fa-clock mr-2"></i>Waktu
                                                </th>
                                                <th class="text-left py-4 px-4 font-semibold text-slate-700">
                                                    <i class="fas fa-map-marker-alt mr-2"></i>Lokasi
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="attendance-list">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <button id="new-session-btn" class="btn-modern glass-card w-full mt-6 py-4 px-6 rounded-2xl text-slate-700 font-semibold text-lg">
                                    <i class="fas fa-plus-circle mr-2"></i>
                                    Buat Sesi Baru
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Referensi DOM ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfoDisplay = document.getElementById('user-info');
        const userEmailDisplay = document.getElementById('user-email');
        const sessionNameInput = document.getElementById('session-name');
        const createSessionBtn = document.getElementById('create-session-btn');
        const createSessionForm = document.getElementById('create-session-form');
        const activeSessionContainer = document.getElementById('active-session-container');
        const activeSessionTitle = document.getElementById('active-session-title');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const qrcodeCanvas = document.getElementById('qrcode-canvas');
        const attendanceList = document.getElementById('attendance-list');
        const attendeeCount = document.getElementById('attendee-count');
        const newSessionBtn = document.getElementById('new-session-btn');
        const sessionStatus = document.getElementById('session-status');
        const closeSessionBtn = document.getElementById('close-session-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const downloadQrBtn = document.getElementById('download-qr');
        const shareQrBtn = document.getElementById('share-qr');

        let currentSessionId = null;
        let unsubscribeFromAttendees = null;
        let attendeesData = []; // Store attendees for CSV export

        // --- Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDb7mCPgC-GAVfd8bjI7hpypF_iYPA4Ob8",
            authDomain: "prensensi-qr.firebaseapp.com",
            projectId: "prensensi-qr",
            storageBucket: "prensensi-qr.appspot.com",
            messagingSenderId: "372766345596",
            appId: "1:372766345596:web:331ddc11a7b461273d3cf9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- Logika Login / Logout ---
        loginBtn.addEventListener('click', () => signInWithPopup(auth, provider).catch(error => console.error("Login Gagal:", error)));
        logoutBtn.addEventListener('click', () => signOut(auth).catch(error => console.error("Logout Gagal:", error)));

        // --- Otentikasi ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                userInfoDisplay.textContent = `Login sebagai: ${user.email}`;
                userEmailDisplay.textContent = user.email;
                 // Debugging: Cetak objek pengguna ke konsol
                console.log("Objek Pengguna:", user);
            } else {
                loginContainer.style.display = 'block';
                appContainer.style.display = 'none';
                if (unsubscribeFromAttendees) unsubscribeFromAttendees();
            }
        });

        // --- Logika Aplikasi ---
        createSessionBtn.addEventListener('click', async () => {
            const sessionName = sessionNameInput.value.trim();
            if (!sessionName) {
                alert("Nama kegiatan tidak boleh kosong.");
                return;
            }

            try {
                const sessionDocRef = await addDoc(collection(db, "kegiatan"), {
                    nama: sessionName,
                    dibuatPada: new Date(),
                    status: 'buka' // Status awal
                });
                currentSessionId = sessionDocRef.id;
                showActiveSession(sessionName);
                generateQRCode(currentSessionId);
                listenForAttendees(currentSessionId);
            } catch (error) {
                console.error("Gagal membuat sesi:", error);
                alert("Gagal membuat sesi baru. Cek console untuk detail.");
            }
        });

        closeSessionBtn.addEventListener('click', async () => {
            if (!currentSessionId) {
                return;
            }
            // Dialog konfirmasi dihapus karena bisa diblokir di beberapa lingkungan.
            try {
                const sessionDocRef = doc(db, "kegiatan", currentSessionId);
                await updateDoc(sessionDocRef, { status: 'tutup' });
                sessionStatus.textContent = 'Sesi Ditutup';
                sessionStatus.className = 'mt-2 text-lg font-semibold text-red-600';
                closeSessionBtn.disabled = true;
                closeSessionBtn.classList.add('opacity-50', 'cursor-not-allowed');
                qrcodeContainer.innerHTML = '<p class="text-slate-500">Sesi telah ditutup.</p>';
            } catch (error) {
                console.error("Gagal menutup sesi:", error);
                alert("Gagal menutup sesi. Cek console untuk detail.");
            }
        });
        
        exportCsvBtn.addEventListener('click', () => {
            if (attendeesData.length === 0) {
                alert("Belum ada peserta yang hadir.");
                return;
            }
            const headers = "Nama,Email,Waktu,Latitude,Longitude";
            const rows = attendeesData.map(p => {
                const time = p.waktu.toDate().toLocaleString('id-ID');
                const lat = p.lokasi ? p.lokasi.lat : 'N/A';
                const lng = p.lokasi ? p.lokasi.lng : 'N/A';
                return `"${p.nama}","${p.email}","${time}",${lat},${lng}`;
            });
            const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + rows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const sessionName = activeSessionTitle.textContent.trim().replace(/ /g, '_');
            link.setAttribute("download", `presensi_${sessionName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        newSessionBtn.addEventListener('click', () => {
            if (unsubscribeFromAttendees) unsubscribeFromAttendees();
            currentSessionId = null;
            attendeesData = [];
            sessionNameInput.value = '';
            createSessionForm.style.display = 'block';
            activeSessionContainer.style.display = 'none';
        });

        function showActiveSession(sessionName) {
            createSessionForm.style.display = 'none';
            activeSessionContainer.style.display = 'block';
            activeSessionTitle.textContent = sessionName;
            sessionStatus.textContent = 'Sesi Terbuka';
            sessionStatus.className = 'mt-2 text-lg font-semibold text-green-600';
            closeSessionBtn.disabled = false;
            closeSessionBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function generateQRCode(sessionId) {
            // PERBAIKAN: Mendapatkan URL dasar tanpa nama file untuk memastikan link selalu benar.
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const url = `${baseUrl}index.html?sessionId=${sessionId}`;
            
            QRCode.toCanvas(qrcodeCanvas, url, { width: 256 }, (error) => {
                if (error) console.error(error);
            });
            qrcodeContainer.innerHTML = '';
            qrcodeContainer.appendChild(qrcodeCanvas);
        }

        function listenForAttendees(sessionId) {
            const attendeesCollectionRef = collection(db, `presensi/${sessionId}/peserta`);
            const q = query(attendeesCollectionRef);
            
            if (unsubscribeFromAttendees) unsubscribeFromAttendees();

            unsubscribeFromAttendees = onSnapshot(q, (snapshot) => {
                attendeesData = snapshot.docs.map(doc => doc.data());
                renderAttendees(attendeesData);
            });
        }

        function renderAttendees(attendees) {
            attendeeCount.textContent = attendees.length;
            if (attendees.length === 0) {
                 attendanceList.innerHTML = '<tr><td colspan="3" class="text-center text-slate-500 py-8">Belum ada peserta yang hadir.</td></tr>';
                 return;
            }
            attendees.sort((a, b) => b.waktu.toDate() - a.waktu.toDate());
            attendanceList.innerHTML = attendees.map(p => {
                const time = p.waktu.toDate().toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const location = p.lokasi ? `<a href="https://www.google.com/maps?q=${p.lokasi.lat},${p.lokasi.lng}" target="_blank" class="text-indigo-600 hover:underline">Lihat Peta</a>` : 'Tidak ada';
                return `
                    <tr class="border-b border-slate-200">
                        <td class="text-slate-800">
                            <div class="font-medium">${escapeHTML(p.nama)}</div>
                            <div class="text-xs text-slate-500">${escapeHTML(p.email)}</div>
                        </td>
                        <td class="text-slate-600">${time}</td>
                        <td class="text-slate-600">${location}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str || "";
            return p.innerHTML;
        }

        // Fitur Download QR Code
        downloadQrBtn.addEventListener('click', () => {
            if (!qrcodeCanvas) return;
            
            const link = document.createElement('a');
            link.download = `qr-presensi-${currentSessionId}.png`;
            link.href = qrcodeCanvas.toDataURL();
            link.click();
        });

        // Fitur Share QR Code
        shareQrBtn.addEventListener('click', async () => {
            if (navigator.share && qrcodeCanvas) {
                try {
                    const blob = await new Promise(resolve => qrcodeCanvas.toBlob(resolve));
                    const file = new File([blob], 'qr-presensi.png', { type: 'image/png' });
                    
                    await navigator.share({
                        title: 'QR Code Presensi',
                        text: 'Scan QR Code ini untuk melakukan presensi',
                        files: [file]
                    });
                } catch (error) {
                    console.log('Share tidak didukung atau dibatalkan');
                    // Fallback: copy to clipboard
                    copyQRToClipboard();
                }
            } else {
                copyQRToClipboard();
            }
        });

        function copyQRToClipboard() {
            if (!qrcodeCanvas) return;
            
            qrcodeCanvas.toBlob(async (blob) => {
                try {
                    await navigator.clipboard.write([
                        new ClipboardItem({
                            'image/png': blob
                        })
                    ]);
                    showNotification('QR Code berhasil disalin ke clipboard!', 'success');
                } catch (error) {
                    console.error('Gagal menyalin ke clipboard:', error);
                    showNotification('Gagal menyalin QR Code', 'error');
                }
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-2xl text-white font-semibold transform transition-all duration-300 ${
                type === 'success' ? 'gradient-bg-success' : 
                type === 'error' ? 'gradient-bg-warning' : 'gradient-bg'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Update stats cards
        function updateStats() {
            const totalParticipants = document.getElementById('total-participants');
            const activeSessions = document.getElementById('active-sessions');
            const todayAttendance = document.getElementById('today-attendance');
            
            if (totalParticipants) totalParticipants.textContent = attendeesData.length;
            if (activeSessions) activeSessions.textContent = currentSessionId ? '1' : '0';
            if (todayAttendance) {
                const today = new Date().toDateString();
                const todayCount = attendeesData.filter(a => 
                    a.waktu.toDate().toDateString() === today
                ).length;
                todayAttendance.textContent = todayCount;
            }
        }

        // Enhanced render attendees with better styling
        function renderAttendees(attendees) {
            attendeeCount.textContent = attendees.length;
            updateStats();
            
            if (attendees.length === 0) {
                attendanceList.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-slate-500 py-12">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-users text-4xl text-slate-300 mb-4"></i>
                                <p class="text-lg">Belum ada peserta yang hadir</p>
                                <p class="text-sm">Peserta akan muncul di sini setelah melakukan presensi</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            attendees.sort((a, b) => b.waktu.toDate() - a.waktu.toDate());
            attendanceList.innerHTML = attendees.map((p, index) => {
                const time = p.waktu.toDate().toLocaleString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                const date = p.waktu.toDate().toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                const location = p.lokasi ? 
                    `<a href="https://www.google.com/maps?q=${p.lokasi.lat},${p.lokasi.lng}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium flex items-center">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        Lihat Peta
                    </a>` : 
                    '<span class="text-slate-400 flex items-center"><i class="fas fa-map-marker-alt mr-2"></i>Tidak ada</span>';
                
                return `
                    <tr class="table-row bg-white hover:bg-blue-50 transition-all duration-200">
                        <td class="py-4 px-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 gradient-bg-secondary rounded-full flex items-center justify-center text-white font-bold text-sm mr-4">
                                    ${p.nama.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-800">${escapeHTML(p.nama)}</div>
                                    <div class="text-sm text-slate-500">${escapeHTML(p.email)}</div>
                                </div>
                            </div>
                        </td>
                        <td class="py-4 px-4">
                            <div class="text-slate-700">
                                <div class="font-medium">${time}</div>
                                <div class="text-sm text-slate-500">${date}</div>
                            </div>
                        </td>
                        <td class="py-4 px-4">
                            ${location}
                        </td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>

